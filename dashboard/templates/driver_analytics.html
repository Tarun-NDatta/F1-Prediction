{% extends 'base.html' %}
{% block title %}Driver Analytics{% endblock %}

{% block extra_css %}
<style>
.analytics-header {
    background: var(--f1-gradient);
    color: white;
    padding: 2rem;
    margin-bottom: 2rem;
    border-radius: 12px;
    text-align: center;
}
.content-box {
    border-radius: 16px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    margin-bottom: 2rem;
    padding: 2rem 1.5rem;
}
body.dark-mode .content-box {
    background: #232527 !important;
    color: #fff !important;
    border: 1px solid #333;
}

/* Chart Container Styling */
.chart-container {
    position: relative;
    height: 400px;
    margin: 2rem 0;
    background: rgba(255,255,255,0.9);
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,0.1);
}
body.dark-mode .chart-container {
    background: rgba(255,255,255,0.05);
    border-color: rgba(255,255,255,0.1);
}

/* Driver Cards */
.driver-card {
    background: #fff;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid var(--f1-red);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
body.dark-mode .driver-card {
    background: #232527;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    border-left-color: var(--f1-red);
}
.driver-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}
.driver-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}
.driver-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--f1-red);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
}
body.dark-mode .driver-number {
    background: var(--f1-red);
    color: white;
}
.driver-info h5 {
    margin: 0;
    color: var(--f1-red);
    font-weight: 600;
}
body.dark-mode .driver-info h5 {
    color: var(--f1-red);
}
.driver-info small {
    color: #6b7280;
    font-size: 0.9rem;
}
body.dark-mode .driver-info small {
    color: #ccc;
}

/* Teammate Comparison */
.teammate-card {
    background: #fff;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 2px solid #e9ecef;
    transition: border-color 0.2s ease;
}
body.dark-mode .teammate-card {
    background: #232527;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    border-color: #333;
}
.teammate-card:hover {
    border-color: var(--f1-red);
}
body.dark-mode .teammate-card:hover {
    border-color: var(--f1-gold);
}
.team-header {
    text-align: center;
    margin-bottom: 1.5rem;
}
.team-header h4 {
    color: var(--f1-red);
    margin-bottom: 0.5rem;
    font-weight: 600;
}
body.dark-mode .team-header h4 {
    color: var(--f1-gold);
}
.driver-comparison {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 1rem;
    align-items: center;
}
.driver-side {
    text-align: center;
    padding: 1rem;
    background: rgba(248, 249, 250, 0.5);
    border-radius: 8px;
}
body.dark-mode .driver-side {
    background: rgba(255,255,255,0.05);
}
.driver-side.winner {
    background: rgba(40, 167, 69, 0.1);
    border: 2px solid #28a745;
}
body.dark-mode .driver-side.winner {
    background: rgba(40, 167, 69, 0.2);
}
.vs-divider {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--f1-red);
}
body.dark-mode .vs-divider {
    color: var(--f1-gold);
}
.points-display {
    font-size: 2rem;
    font-weight: bold;
    color: var(--f1-red);
    margin-bottom: 0.5rem;
}
body.dark-mode .points-display {
    color: var(--f1-gold);
}
.difference-badge {
    background: var(--f1-red);
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    margin-top: 0.5rem;
}
body.dark-mode .difference-badge {
    background: var(--f1-gold);
    color: #232527;
}

/* Year Selector */
.year-selector {
    display: flex;
    justify-content: center;
    margin-bottom: 2rem;
    gap: 1rem;
    flex-wrap: wrap;
}
.year-btn {
    background: none;
    border: 2px solid var(--f1-red);
    color: var(--f1-red);
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
}
body.dark-mode .year-btn {
    border-color: var(--f1-red);
    color: var(--f1-red);
}
.year-btn:hover,
.year-btn.active {
    background: var(--f1-red);
    color: white;
}
body.dark-mode .year-btn:hover,
body.dark-mode .year-btn.active {
    background: var(--f1-red);
    color: white;
}

/* Responsive Design */
@media (max-width: 768px) {
    .chart-container {
        height: 300px;
    }
    .driver-comparison {
        grid-template-columns: 1fr;
        gap: 0.5rem;
    }
    .vs-divider {
        display: none;
    }
    .year-selector {
        flex-direction: column;
        align-items: center;
    }
    .year-btn {
        width: 100px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="analytics-header">
    <h1><i class="fas fa-user-friends me-2"></i>Driver Analytics</h1>
    <p class="lead">Driver Performance Analysis & Teammate Comparisons</p>
</div>

<!-- Year Selector -->
<div class="year-selector">
    <button class="year-btn {% if selected_year == 2025 %}active{% endif %}" onclick="window.location.href='?year=2025'">2025</button>
    <button class="year-btn {% if selected_year == 2024 %}active{% endif %}" onclick="window.location.href='?year=2024'">2024</button>
    <button class="year-btn {% if selected_year == 2023 %}active{% endif %}" onclick="window.location.href='?year=2023'">2023</button>
    <button class="year-btn {% if selected_year == 2022 %}active{% endif %}" onclick="window.location.href='?year=2022'">2022</button>
</div>

<!-- Driver Points Progression Chart -->
<div class="content-box">
    <h3><i class="fas fa-chart-line me-2"></i>Driver Points Progression</h3>
    <p class="text-muted">Cumulative points progression throughout the {{ selected_year }} season</p>
    <div class="chart-container">
        <canvas id="driverProgressionChart"></canvas>
    </div>
</div>

<!-- Teammate Comparisons -->
<div class="content-box">
    <h3><i class="fas fa-balance-scale me-2"></i>Teammate Comparisons</h3>
    <p class="text-muted">Head-to-head points comparison between teammates</p>
    
    {% for comparison in teammate_comparisons %}
    <div class="teammate-card">
        <div class="team-header">
            <h4>{{ comparison.team.name }}</h4>
            <small>Points Difference: {{ comparison.difference }}</small>
        </div>
        <div class="driver-comparison">
            <div class="driver-side {% if comparison.driver1.points > comparison.driver2.points %}winner{% endif %}">
                <div class="points-display">{{ comparison.driver1.points }}</div>
                <div>{{ comparison.driver1.driver.given_name }} {{ comparison.driver1.driver.family_name }}</div>
                <div class="difference-badge">
                    {% if comparison.driver1.points > comparison.driver2.points %}
                        +{{ comparison.difference }}
                    {% else %}
                        -{{ comparison.difference }}
                    {% endif %}
                </div>
            </div>
            <div class="vs-divider">VS</div>
            <div class="driver-side {% if comparison.driver2.points > comparison.driver1.points %}winner{% endif %}">
                <div class="points-display">{{ comparison.driver2.points }}</div>
                <div>{{ comparison.driver2.driver.given_name }} {{ comparison.driver2.driver.family_name }}</div>
                <div class="difference-badge">
                    {% if comparison.driver2.points > comparison.driver1.points %}
                        +{{ comparison.difference }}
                    {% else %}
                        -{{ comparison.difference }}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="text-center text-muted">
        <i class="fas fa-info-circle fa-3x mb-3"></i>
        <p>No teammate comparisons available for {{ selected_year }}</p>
    </div>
    {% endfor %}
</div>

<!-- Top Drivers Summary removed as requested -->
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('driverProgressionChart').getContext('2d');
    
    // Prepare data for the chart
    const chartData = {
        labels: [
            {% for event in events %}
                '{{ event.name }}',
            {% endfor %}
        ],
        datasets: [
            {% for driver_data in driver_standings_data|slice:":8" %}
            {
                label: '{{ driver_data.driver.given_name }} {{ driver_data.driver.family_name }}',
                data: [
                    {% for point in driver_data.points_progression %}
                        {{ point.cumulative_points }},
                    {% endfor %}
                ],
                borderColor: getDriverColor({{ forloop.counter0 }}),
                backgroundColor: getDriverColor({{ forloop.counter0 }}, 0.1),
                borderWidth: 2,
                fill: false,
                tension: 0.4
            },
            {% endfor %}
        ]
    };
    
    // Create the chart
    new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Race'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Cumulative Points'
                    },
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
});

// Function to generate colors for drivers
function getDriverColor(index, alpha = 1) {
    const colors = [
        `rgba(220, 20, 60, ${alpha})`,    // Red
        `rgba(0, 210, 190, ${alpha})`,    // Teal
        `rgba(255, 135, 0, ${alpha})`,    // Orange
        `rgba(0, 144, 255, ${alpha})`,    // Blue
        `rgba(144, 0, 0, ${alpha})`,      // Dark Red
        `rgba(0, 111, 98, ${alpha})`,     // Green
        `rgba(90, 0, 255, ${alpha})`,     // Purple
        `rgba(255, 215, 0, ${alpha})`,    // Gold
    ];
    return colors[index % colors.length];
}
</script>
{% endblock %} 