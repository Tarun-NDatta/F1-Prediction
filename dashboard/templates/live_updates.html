{% extends 'base.html' %}
{% load dashboard_extras %}

{% block title %}Live Updates - F1 Race Commentary{% endblock %}

{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/live_updates.css' %}">
<style>
/* Dark mode text visibility fixes */
body.dark-mode .commentary-time,
body.dark-mode .prediction-change,
body.dark-mode .text-muted,
body.dark-mode .coming-soon {
    color: #9ca3af !important;
}

body.dark-mode .commentary-text,
body.dark-mode .prediction-driver,
body.dark-mode .form-label,
body.dark-mode h4, 
body.dark-mode h5, 
body.dark-mode h6,
body.dark-mode p,
body.dark-mode small {
    color: #e5e7eb !important;
}

body.dark-mode .prediction-comparison span {
    color: #e5e7eb !important;
}

body.dark-mode .prediction-comparison small {
    color: #9ca3af !important;
}

.live-toggle {
    display: inline-block;
    margin-left: 10px;
}

.live-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: #dc3545;
    color: white;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.9rem;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
}

.live-indicator.inactive {
    background: #6c757d;
}

.live-indicator .pulse {
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    animation: pulse 1.5s ease-in-out infinite;
}

.live-indicator.inactive .pulse {
    animation: none;
}

@keyframes pulse {
    0% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.5;
        transform: scale(0.8);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}

.commentary-section {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    height: 400px;
    overflow-y: auto;
    border: 1px solid #e9ecef;
}

body.dark-mode .commentary-section {
    background: #232527;
    border-color: #333;
}

.commentary-item {
    padding: 0.8rem;
    margin-bottom: 0.8rem;
    border-left: 3px solid #dc0000;
    background: white;
    border-radius: 0 8px 8px 0;
}

body.dark-mode .commentary-item {
    background: #2a2d30;
}

.prediction-updates {
    background: #e8f4fd;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    height: 400px;
    overflow-y: auto;
    border: 1px solid #bee5eb;
}

body.dark-mode .prediction-updates {
    background: #1a1d1f;
    border-color: #2c3e50;
}

.prediction-item {
    padding: 0.8rem;
    margin-bottom: 0.8rem;
    background: white;
    border-radius: 8px;
    border-left: 3px solid #17a2b8;
}

body.dark-mode .prediction-item {
    background: #2a2d30;
}

.mock-race-details {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}

body.dark-mode .mock-race-details {
    background: #232527;
}

.grid-position {
    display: inline-block;
    background: #f8f9fa;
    padding: 0.3rem 0.6rem;
    margin: 0.2rem;
    border-radius: 4px;
    font-size: 0.85rem;
    color: #212529;
}

body.dark-mode .grid-position {
    background: #2a2d30;
    color: #e5e7eb;
}

.grid-position.pole {
    background: #ffd700;
    color: #000;
    font-weight: bold;
}

.grid-position.front-row {
    background: #c0c0c0;
    color: #000;
    font-weight: bold;
}

.grid-position.top-10 {
    background: #cd7f32;
    color: #fff;
}

.race-progress-section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}

body.dark-mode .race-progress-section {
    background: #232527;
}

.race-info {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

body.dark-mode .race-info {
    background: rgba(255, 255, 255, 0.05);
}

.race-progress {
    background: rgba(255, 255, 255, 0.2);
    height: 8px;
    border-radius: 4px;
    margin: 1rem 0;
    overflow: hidden;
}

.race-progress-bar {
    background: #fff;
    height: 100%;
    width: 35%;
    border-radius: 4px;
    transition: width 0.3s ease;
}

.pre-race-predictions, .live-predictions {
    background: #fff3cd;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

body.dark-mode .pre-race-predictions,
body.dark-mode .live-predictions {
    background: #332b00;
}

.prediction-comparison {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    margin: 0.2rem 0;
    background: #f8f9fa;
    border-radius: 4px;
}

body.dark-mode .prediction-comparison {
    background: #2a2d30;
}

@media (max-width: 768px) {
    .commentary-section,
    .prediction-updates {
        height: 300px;
    }
    
    .d-flex.gap-2 {
        flex-direction: column;
        gap: 0.5rem !important;
    }
    
    .live-toggle {
        margin-left: 0;
        margin-top: 10px;
        width: 100%;
    }
    
    .live-indicator {
        width: 100%;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Live Header -->
    <div class="live-header">
        <h1><i class="fas fa-broadcast-tower me-2"></i>Live Race Updates</h1>
        {% if current_event %}
            <h3>{{ current_event.name }}</h3>
            <p class="mb-0">
                <i class="fas fa-map-marker-alt me-1"></i>{{ current_event.circuit.name }} |
                <i class="fas fa-calendar me-1"></i>{{ current_event.date|date:"F j, Y" }}
            </p>
            <div class="live-status">
                <i class="fas fa-circle text-warning me-1"></i>Waiting for Race to Start
            </div>
        {% else %}
            <h3>No Upcoming Races</h3>
            <p class="mb-0">Check back later for live updates</p>
        {% endif %}
    </div>

    <!-- Mock Race Simulation Interface -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="content-box">
                <h4 class="mb-3">
                    <i class="fas fa-play-circle me-2"></i>Mock Live Race Simulation
                </h4>
                <p class="text-muted mb-3">
                    Experience how live ML predictions work with our realistic race simulation.
                    Choose from different tracks and see how predictions evolve during a race.
                </p>

                <!-- Simulation Controls -->
                <div class="row" id="simulationControls">
                    <div class="col-md-3">
                        <label class="form-label">Select Track</label>
                        <select class="form-select" id="trackSelect">
                            <option value="Australian Grand Prix" data-laps="58">Australia (Melbourne)</option>
                            <option value="Italian Grand Prix" data-laps="53">Monza (Italy)</option>
                            <option value="Dutch Grand Prix" data-laps="72">Silverstone-style Circuit</option>
                            <option value="Singapore Grand Prix" data-laps="61">Singapore (Street)</option>
                            <option value="Azerbaijan Grand Prix" data-laps="51">Azerbaijan (Street)</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Race Speed</label>
                        <select class="form-select" id="speedSelect">
                            <option value="5">5 minutes</option>
                            <option value="10" selected>10 minutes</option>
                            <option value="15">15 minutes</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Actions</label>
                        <div class="d-flex align-items-end gap-2">
                            <button class="btn btn-success" id="startRaceBtn">
                                <i class="fas fa-play me-1"></i>Start Mock Race
                            </button>
                            <button class="btn btn-danger d-none" id="stopRaceBtn">
                                <i class="fas fa-stop me-1"></i>Stop Race
                            </button>
                            <div class="live-toggle">
                                <button class="live-indicator inactive" id="liveToggle">
                                    <span class="pulse"></span>
                                    <span id="liveStatus">LIVE</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Race Status</label>
                        <div id="raceStatus" class="alert alert-secondary mb-0">
                            <i class="fas fa-circle text-secondary me-1"></i>No active simulation
                        </div>
                    </div>
                </div>

                <!-- Interactive Events (shown during race) -->
                <div class="row mt-3 d-none" id="interactiveEvents">
                    <div class="col-12">
                        <h6>Interactive Events <span class="badge bg-primary" id="eventsRemaining">2 remaining</span></h6>
                        <div class="btn-group" role="group">
                            <button class="btn btn-warning btn-sm" id="safetyCarBtn">
                                <i class="fas fa-car me-1"></i>Safety Car
                            </button>
                            <button class="btn btn-info btn-sm" id="badPitStopBtn">
                                <i class="fas fa-tools me-1"></i>Bad Pit Stop
                            </button>
                            <button class="btn btn-primary btn-sm" id="weatherChangeBtn">
                                <i class="fas fa-cloud-rain me-1"></i>Weather Change
                            </button>
                        </div>
                        <small class="text-muted d-block mt-1">
                            You can trigger up to 2 events during the race (stops at 10 laps to go)
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mock Race Details -->
    <div class="row mb-4 d-none" id="mockRaceDetails">
        <div class="col-12">
            <div class="mock-race-details">
                <h4 class="mb-3">
                    <i class="fas fa-info-circle me-2"></i>Mock Race Context
                </h4>
                <div class="row">
                    <div class="col-md-6">
                        <h6>Starting Grid (Qualifying Results)</h6>
                        <div id="startingGrid">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>ML Predictions Timeline</h6>
                        <div id="predictionTimeline">
                            <div class="pre-race-predictions" id="preRacePredictions">
                                <strong>Pre-Race ML Prediction:</strong>
                                <div id="preRacePredictionContent">
                                    <em>Available after race starts</em>
                                </div>
                            </div>
                            <div class="live-predictions d-none" id="livePredictions">
                                <strong>Current Live Prediction:</strong>
                                <div id="livePredictionContent">
                                    <em>Updates during race</em>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Live Commentary -->
        <div class="col-lg-8">
            <div class="commentary-section" id="commentarySection">
                <h4 class="mb-3">
                    <i class="fas fa-microphone me-2"></i>Live Commentary
                    <span class="badge bg-secondary ms-2" id="commentaryStatus">Waiting</span>
                </h4>

                <div id="commentaryFeed">
                    {% if current_event %}
                        <div class="commentary-item">
                            <div class="commentary-time">Pre-Race</div>
                            <div class="commentary-text">
                                Welcome to the {{ current_event.name }}! Toggle LIVE mode or start a mock simulation to see live commentary in action.
                            </div>
                        </div>
                    {% else %}
                        <div class="coming-soon">
                            <i class="fas fa-clock"></i>
                            <h5>No Live Race</h5>
                            <p>Toggle LIVE mode for real race data or start a mock race simulation to see live commentary and ML predictions in action.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Prediction Updates -->
        <div class="col-lg-4">
            <div class="prediction-updates" id="predictionUpdates">
                <h4 class="mb-3">
                    <i class="fas fa-chart-line me-2"></i>ML Prediction Updates
                    <span class="badge bg-secondary ms-2" id="mlStatus">Stopped</span>
                </h4>

                <div id="predictionFeed">
                    <div class="coming-soon">
                        <i class="fas fa-robot"></i>
                        <h5>ML Predictions</h5>
                        <p>Toggle LIVE mode for real ML predictions or start a mock race to see live ML prediction updates. Models will update every 30 seconds until 10 laps to go.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Race Progress -->
    <div class="row">
        <div class="col-12">
            {% if current_event %}
                <div class="race-progress-section">
                    <h4 class="mb-3">
                        <i class="fas fa-flag-checkered me-2"></i>Race Progress
                    </h4>

                    <div class="race-info">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Lap:</strong> <span id="currentLap">0/53</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Leader:</strong> <span id="currentLeader">Grid Formation</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Gap:</strong> <span id="leaderGap">----</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Weather:</strong> <span id="currentWeather">Clear</span>
                            </div>
                        </div>
                    </div>

                    <div class="race-progress">
                        <div class="race-progress-bar" id="raceProgressBar"></div>
                    </div>

                    <div class="text-center">
                        <small class="text-muted" id="raceProgressText">
                            Race will begin in approximately 5 minutes
                        </small>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // State management
    let currentMode = 'idle'; // 'idle', 'live', 'mock'
    let mockRaceData = null;
    let raceInterval = null;
    let liveDataInterval = null;
    let eventCount = 0;
    const maxEvents = 2;

    // F1 2025 drivers list
    const f1_2025_drivers = [
        'Max Verstappen', 'Sergio Perez', 'Lewis Hamilton', 'George Russell',
        'Charles Leclerc', 'Carlos Sainz', 'Lando Norris', 'Oscar Piastri',
        'Fernando Alonso', 'Lance Stroll', 'Esteban Ocon', 'Pierre Gasly',
        'Alexander Albon', 'Logan Sargeant', 'Valtteri Bottas', 'Zhou Guanyu',
        'Kevin Magnussen', 'Nico Hulkenberg', 'Yuki Tsunoda', 'Daniel Ricciardo'
    ];

    // Track-specific commentary templates
    const trackCommentary = {
        'Australian Grand Prix': [
            'into Turn 1 at Melbourne',
            'through the tricky middle sector',
            'approaching the Albert Park chicane',
            'down the long back straight',
            'fighting for position at Turn 3'
        ],
        'Italian Grand Prix': [
            'through the Temple of Speed at Monza',
            'slipstreaming down the main straight',
            'into the first chicane',
            'through Lesmo 1 and 2',
            'approaching the Parabolica'
        ],
        'Dutch Grand Prix': [
            'through the banked Turn 3',
            'navigating the technical middle sector',
            'into the challenging final sector',
            'battling through the sweeping corners',
            'down the pit straight'
        ],
        'Singapore Grand Prix': [
            'under the lights in Singapore',
            'through the street circuit chicanes',
            'navigating the Marina Bay complex',
            'along the Singapore Sling section',
            'under the Anderson Bridge'
        ],
        'Azerbaijan Grand Prix': [
            'down the longest straight in F1',
            'through the narrow castle section',
            'approaching Turn 1 in Baku',
            'navigating the 90-degree corners',
            'along the seafront boulevard'
        ]
    };

    // Event listeners
    document.getElementById('liveToggle').addEventListener('click', toggleLiveMode);
    document.getElementById('startRaceBtn').addEventListener('click', startMockRace);
    document.getElementById('stopRaceBtn').addEventListener('click', stopMockRace);
    document.getElementById('safetyCarBtn').addEventListener('click', () => triggerEvent('safety_car'));
    document.getElementById('badPitStopBtn').addEventListener('click', () => triggerEvent('bad_pit_stop'));
    document.getElementById('weatherChangeBtn').addEventListener('click', () => triggerEvent('weather_change'));

    // Auto-scroll functionality
    function scrollToBottom(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
            element.scrollTop = element.scrollHeight;
        }
    }

    // Mode switching functions
    function switchToMode(newMode) {
        // Clear any existing intervals
        clearAllIntervals();
        
        const toggle = document.getElementById('liveToggle');
        const commentaryStatus = document.getElementById('commentaryStatus');
        const mlStatus = document.getElementById('mlStatus');
        
        currentMode = newMode;
        
        switch(newMode) {
            case 'live':
                toggle.classList.remove('inactive');
                updateStatus(commentaryStatus, 'Live', 'success');
                updateStatus(mlStatus, 'Active', 'success');
                startLiveMode();
                break;
                
            case 'mock':
                toggle.classList.add('inactive');
                updateStatus(commentaryStatus, 'Mock Race', 'warning');
                updateStatus(mlStatus, 'Simulated', 'warning');
                // Mock race logic handled in startMockRace()
                break;
                
            case 'idle':
                toggle.classList.add('inactive');
                updateStatus(commentaryStatus, 'Waiting', 'secondary');
                updateStatus(mlStatus, 'Stopped', 'secondary');
                resetToDefaultContent();
                resetMockRaceUI();
                break;
        }
    }

    function updateStatus(element, text, type) {
        element.className = `badge bg-${type} ms-2`;
        element.textContent = text;
    }

    function clearAllIntervals() {
        if (raceInterval) {
            clearInterval(raceInterval);
            raceInterval = null;
        }
        if (liveDataInterval) {
            clearInterval(liveDataInterval);
            liveDataInterval = null;
        }
    }

    function toggleLiveMode() {
        if (currentMode === 'live') {
            switchToMode('idle');
        } else {
            // Stop any mock race first
            if (currentMode === 'mock') {
                stopMockRace(false); // Don't switch to idle, we'll switch to live
            }
            switchToMode('live');
        }
    }

    function startLiveMode() {
        clearCommentaryFeed();
        clearPredictionFeed();
        
        addCommentary('LIVE', 'Live mode activated. Waiting for real race data...');
        addPrediction('LIVE ML PREDICTIONS', 'Waiting for real-time ML prediction data...');
        
        // Simulate live data polling (replace with real API calls when available)
        liveDataInterval = setInterval(() => {
            addCommentary('LIVE', 'No live race currently active. Real data will appear here during race weekends.');
        }, 30000); // Every 30 seconds
    }

    function startMockRace() {
        if (currentMode === 'live') {
            switchToMode('idle');
        }
        
        const trackName = document.getElementById('trackSelect').value;
        const speedMinutes = parseInt(document.getElementById('speedSelect').value);
        const trackOption = document.getElementById('trackSelect').selectedOptions[0];
        const totalLaps = parseInt(trackOption.dataset.laps);
        
        // Initialize mock race data
        mockRaceData = {
            trackName: trackName,
            totalLaps: totalLaps,
            currentLap: 0,
            speedMinutes: speedMinutes,
            lapInterval: (speedMinutes * 60 * 1000) / totalLaps, // milliseconds per lap
            drivers: generateStartingOrder(),
            weather: 'Clear',
            leader: null,
            raceEvents: [],
            mlUpdatesActive: true
        };
        
        switchToMode('mock');
        
        // Update UI
        showMockRaceUI();
        generateStartingGrid();
        generatePreRacePrediction();
        
        // Clear feeds and start race
        clearCommentaryFeed();
        clearPredictionFeed();
        
        addCommentary('Race Control', `${trackName} simulation started! ${totalLaps} laps ahead.`);
        addPrediction('Pre-Race', 'ML models initialized. Predictions will update as race progresses.');
        
        updateRaceProgress();
        
        // Start race simulation
        raceInterval = setInterval(simulateLap, mockRaceData.lapInterval);
        
        updateRaceStatus(`Race Started: ${trackName}`, 'success');
        eventCount = 0;
        updateEventButtons();
    }

    function stopMockRace(switchToIdle = true) {
        clearAllIntervals();
        mockRaceData = null;
        
        if (switchToIdle) {
            switchToMode('idle');
        }
        
        updateRaceStatus('No active simulation', 'secondary');
    }

    function simulateLap() {
        if (!mockRaceData || currentMode !== 'mock') return;
        
        mockRaceData.currentLap++;
        const isRaceFinished = mockRaceData.currentLap >= mockRaceData.totalLaps;
        
        // Stop ML updates 10 laps before end
        const lapsFromEnd = mockRaceData.totalLaps - mockRaceData.currentLap;
        if (lapsFromEnd <= 10) {
            mockRaceData.mlUpdatesActive = false;
        }
        
        // Generate race events and commentary
        generateLapEvents();
        
        // Update predictions (every few laps and if ML is active)
        if (mockRaceData.mlUpdatesActive && (mockRaceData.currentLap % 3 === 0 || mockRaceData.currentLap <= 5)) {
            updateMLPredictions();
        }
        
        updateRaceProgress();
        
        if (isRaceFinished) {
            finishMockRace();
        }
    }

    function generateLapEvents() {
        const lap = mockRaceData.currentLap;
        const commentary = trackCommentary[mockRaceData.trackName] || ['around the circuit'];
        const randomAction = commentary[Math.floor(Math.random() * commentary.length)];
        
        // Random events
        if (Math.random() < 0.3) { // 30% chance of commentary each lap
            const drivers = mockRaceData.drivers;
            const driver1 = drivers[Math.floor(Math.random() * Math.min(6, drivers.length))];
            const driver2 = drivers[Math.floor(Math.random() * Math.min(6, drivers.length))];
            
            if (driver1 !== driver2) {
                const events = [
                    `${driver1} is challenging ${driver2} ${randomAction}`,
                    `Great battle between ${driver1} and ${driver2} ${randomAction}`,
                    `${driver1} takes the inside line ${randomAction}`,
                    `${driver2} defends position from ${driver1} ${randomAction}`,
                    `Side by side action with ${driver1} and ${driver2}`
                ];
                
                addCommentary(`Lap ${lap}`, events[Math.floor(Math.random() * events.length)]);
            }
        }
        
        // Pit stop events
        if (lap > 10 && Math.random() < 0.2) {
            const driver = mockRaceData.drivers[Math.floor(Math.random() * 8)];
            addCommentary(`Lap ${lap}`, `${driver} heads into the pits for a tire change`);
        }
        
        // Position updates
        if (lap % 5 === 0) {
            mockRaceData.leader = mockRaceData.drivers[0];
            addCommentary(`Lap ${lap}`, `${mockRaceData.leader} continues to lead the field`);
        }
    }

    function updateMLPredictions() {
        // Shuffle drivers slightly to simulate position changes
        if (Math.random() < 0.7) {
            const pos1 = Math.floor(Math.random() * 6);
            const pos2 = Math.floor(Math.random() * 6);
            [mockRaceData.drivers[pos1], mockRaceData.drivers[pos2]] = [mockRaceData.drivers[pos2], mockRaceData.drivers[pos1]];
        }
        
        // Add prediction update
        const predictions = mockRaceData.drivers.slice(0, 3);
        addPrediction(`Lap ${mockRaceData.currentLap}`, `Updated predictions: 1. ${predictions[0]} 2. ${predictions[1]} 3. ${predictions[2]}`);
        
        // Update live predictions display
        updateLivePredictionDisplay();
    }

    function updateLivePredictionDisplay() {
        document.getElementById('livePredictions').classList.remove('d-none');
        const content = document.getElementById('livePredictionContent');
        
        let html = '';
        mockRaceData.drivers.slice(0, 5).forEach((driver, index) => {
            html += `
                <div class="prediction-comparison">
                    <span>P${index + 1}: ${driver}</span>
                    <small class="text-muted">Lap ${mockRaceData.currentLap} model</small>
                </div>
            `;
        });
        
        content.innerHTML = html;
    }

    function triggerEvent(eventType) {
        if (!mockRaceData || eventCount >= maxEvents || currentMode !== 'mock') return;
        
        const lap = mockRaceData.currentLap;
        const lapsFromEnd = mockRaceData.totalLaps - lap;
        
        // Can't trigger events in last 10 laps
        if (lapsFromEnd <= 10) {
            addCommentary('System', 'No more events can be triggered - too close to race end');
            return;
        }
        
        eventCount++;
        const driver = mockRaceData.drivers[Math.floor(Math.random() * 8)];
        
        let message = '';
        switch(eventType) {
            case 'safety_car':
                message = 'SAFETY CAR DEPLOYED! All cars bunch up behind the safety car';
                mockRaceData.weather = 'Safety Car';
                break;
            case 'bad_pit_stop':
                message = `Disaster for ${driver}! A slow pit stop costs them valuable time`;
                // Shuffle this driver down a few positions
                const driverIndex = mockRaceData.drivers.indexOf(driver);
                if (driverIndex !== -1 && driverIndex < 10) {
                    mockRaceData.drivers.splice(driverIndex, 1);
                    const newPos = Math.min(driverIndex + 3, mockRaceData.drivers.length);
                    mockRaceData.drivers.splice(newPos, 0, driver);
                }
                break;
            case 'weather_change':
                message = 'Weather conditions changing! Light rain starting to fall';
                mockRaceData.weather = 'Light Rain';
                break;
        }
        
        addCommentary(`Lap ${lap}`, message);
        updateEventButtons();
    }

    function finishMockRace() {
        clearAllIntervals();
        
        addCommentary('CHECKERED FLAG', `Race finished! ${mockRaceData.drivers[0]} takes the victory!`);
        addPrediction('Final Result', `Winner: ${mockRaceData.drivers[0]} - Mock race completed`);
        
        updateRaceStatus('Race Finished', 'primary');
        
        // Show final results
        setTimeout(() => {
            let resultsMessage = 'Final Results: ';
            mockRaceData.drivers.slice(0, 5).forEach((driver, index) => {
                resultsMessage += `P${index + 1}: ${driver}${index < 4 ? ', ' : ''}`;
            });
            addCommentary('Results', resultsMessage);
        }, 2000);
        
        // Reset UI after a delay
        setTimeout(() => {
            switchToMode('idle');
        }, 5000);
    }

    function updateRaceProgress() {
        if (!mockRaceData) return;
        
        const progress = (mockRaceData.currentLap / mockRaceData.totalLaps) * 100;
        const leader = mockRaceData.drivers[0] || 'Unknown';
        
        document.getElementById('currentLap').textContent = `${mockRaceData.currentLap}/${mockRaceData.totalLaps}`;
        document.getElementById('currentLeader').textContent = leader;
        document.getElementById('currentWeather').textContent = mockRaceData.weather;
        document.getElementById('raceProgressBar').style.width = `${progress}%`;
        
        if (mockRaceData.currentLap === 0) {
            document.getElementById('raceProgressText').textContent = 'Race starting...';
        } else if (mockRaceData.currentLap >= mockRaceData.totalLaps) {
            document.getElementById('raceProgressText').textContent = 'Race finished!';
        } else {
            const lapsRemaining = mockRaceData.totalLaps - mockRaceData.currentLap;
            document.getElementById('raceProgressText').textContent = `${lapsRemaining} laps remaining`;
        }
    }

    function generateStartingOrder() {
        return [...f1_2025_drivers].slice(0, 20).sort(() => Math.random() - 0.5);
    }

    function generateStartingGrid() {
        const startingGrid = document.getElementById('startingGrid');
        const order = mockRaceData.drivers;

        let gridHtml = '';
        order.slice(0, 10).forEach((driver, index) => {
            const position = index + 1;
            let positionClass = 'grid-position';

            if (position === 1) {
                positionClass += ' pole';
            } else if (position === 2) {
                positionClass += ' front-row';
            } else if (position <= 10) {
                positionClass += ' top-10';
            }

            gridHtml += `<span class="${positionClass}">P${position}: ${driver}</span>`;
        });

        startingGrid.innerHTML = gridHtml;
    }

    function generatePreRacePrediction() {
        const preRaceContent = document.getElementById('preRacePredictionContent');
        let predictionHtml = '';

        mockRaceData.drivers.slice(0, 5).forEach((driver, index) => {
            const position = index + 1;
            predictionHtml += `
                <div class="prediction-comparison">
                    <span>P${position}: ${driver}</span>
                    <small class="text-muted">Pre-race model</small>
                </div>
            `;
        });

        preRaceContent.innerHTML = predictionHtml;
    }

    function showMockRaceUI() {
        document.getElementById('mockRaceDetails').classList.remove('d-none');
        document.getElementById('startRaceBtn').classList.add('d-none');
        document.getElementById('stopRaceBtn').classList.remove('d-none');
        document.getElementById('interactiveEvents').classList.remove('d-none');
    }

    function resetMockRaceUI() {
        document.getElementById('mockRaceDetails').classList.add('d-none');
        document.getElementById('startRaceBtn').classList.remove('d-none');
        document.getElementById('stopRaceBtn').classList.add('d-none');
        document.getElementById('interactiveEvents').classList.add('d-none');
        
        // Reset race progress
        document.getElementById('currentLap').textContent = '0/53';
        document.getElementById('currentLeader').textContent = 'Grid Formation';
        document.getElementById('leaderGap').textContent = '----';
        document.getElementById('currentWeather').textContent = 'Clear';
        document.getElementById('raceProgressBar').style.width = '0%';
        document.getElementById('raceProgressText').textContent = 'Race will begin in approximately 5 minutes';
    }

    function updateEventButtons() {
        const remaining = maxEvents - eventCount;
        document.getElementById('eventsRemaining').textContent = `${remaining} remaining`;
        
        const eventButtons = ['safetyCarBtn', 'badPitStopBtn', 'weatherChangeBtn'];
        eventButtons.forEach(btnId => {
            const btn = document.getElementById(btnId);
            btn.disabled = remaining <= 0 || !mockRaceData || 
                         (mockRaceData.totalLaps - mockRaceData.currentLap) <= 10;
        });
    }

    function updateRaceStatus(message, type) {
        const statusElement = document.getElementById('raceStatus');
        statusElement.className = `alert alert-${type} mb-0`;

        const iconMap = {
            'success': 'fas fa-circle text-success',
            'warning': 'fas fa-circle text-warning', 
            'danger': 'fas fa-circle text-danger',
            'primary': 'fas fa-checkered-flag text-primary',
            'secondary': 'fas fa-circle text-secondary'
        };

        statusElement.innerHTML = `<i class="${iconMap[type]} me-1"></i>${message}`;
    }

    // Feed management functions
    function clearCommentaryFeed() {
        document.getElementById('commentaryFeed').innerHTML = '';
    }

    function clearPredictionFeed() {
        document.getElementById('predictionFeed').innerHTML = '';
    }

    function addCommentary(time, message) {
        const commentaryFeed = document.getElementById('commentaryFeed');
        const commentaryItem = document.createElement('div');
        commentaryItem.className = 'commentary-item';
        commentaryItem.innerHTML = `
            <div class="commentary-time">${time}</div>
            <div class="commentary-text">${message}</div>
        `;

        commentaryFeed.appendChild(commentaryItem);
        scrollToBottom('commentarySection');

        // Keep only last 20 items
        const items = commentaryFeed.children;
        if (items.length > 20) {
            commentaryFeed.removeChild(items[0]);
        }
    }

    function addPrediction(driver, change) {
        const predictionFeed = document.getElementById('predictionFeed');
        const predictionItem = document.createElement('div');
        predictionItem.className = 'prediction-item';
        predictionItem.innerHTML = `
            <div class="prediction-driver">${driver}</div>
            <div class="prediction-change">${change}</div>
        `;

        predictionFeed.appendChild(predictionItem);
        scrollToBottom('predictionUpdates');

        // Keep only last 15 items
        const items = predictionFeed.children;
        if (items.length > 15) {
            predictionFeed.removeChild(items[0]);
        }
    }

    function resetToDefaultContent() {
        clearCommentaryFeed();
        clearPredictionFeed();
        
        // Reset commentary
        document.getElementById('commentaryFeed').innerHTML = `
            <div class="coming-soon">
                <i class="fas fa-clock"></i>
                <h5>No Live Race</h5>
                <p>Toggle LIVE mode for real race data or start a mock race simulation to see live commentary and ML predictions in action.</p>
            </div>
        `;

        // Reset predictions
        document.getElementById('predictionFeed').innerHTML = `
            <div class="coming-soon">
                <i class="fas fa-robot"></i>
                <h5>ML Predictions</h5>
                <p>Toggle LIVE mode for real ML predictions or start a mock race to see live ML prediction updates. Models will update every 30 seconds until 10 laps to go.</p>
            </div>
        `;
        
        // Reset prediction timeline
        document.getElementById('preRacePredictionContent').innerHTML = '<em>Available after race starts</em>';
        document.getElementById('livePredictionContent').innerHTML = '<em>Updates during race</em>';
        document.getElementById('livePredictions').classList.add('d-none');
    }

    // Initialize page
    scrollToBottom('commentarySection');
    scrollToBottom('predictionUpdates');
});
</script>
{% endblock %}