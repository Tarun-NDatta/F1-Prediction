{% extends 'base.html' %}
{% load dashboard_extras %}

{% block title %}Live Updates - F1 Race Commentary{% endblock %}

{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/live_updates.css' %}">
<style>
/* Dark mode text visibility fixes */
body.dark-mode .commentary-time,
body.dark-mode .prediction-change,
body.dark-mode .text-muted,
body.dark-mode .coming-soon {
    color: #9ca3af !important;
}

body.dark-mode .commentary-text,
body.dark-mode .prediction-driver,
body.dark-mode .form-label,
body.dark-mode h4, 
body.dark-mode h5, 
body.dark-mode h6,
body.dark-mode p,
body.dark-mode small {
    color: #e5e7eb !important;
}

body.dark-mode .prediction-comparison span {
    color: #e5e7eb !important;
}

body.dark-mode .prediction-comparison small {
    color: #9ca3af !important;
}

.live-toggle {
    display: inline-block;
    margin-left: 10px;
}

.live-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: #dc3545;
    color: white;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.9rem;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
}

.live-indicator.inactive {
    background: #6c757d;
}

.live-indicator .pulse {
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    animation: pulse 1.5s ease-in-out infinite;
}

.live-indicator.inactive .pulse {
    animation: none;
}

@keyframes pulse {
    0% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.5;
        transform: scale(0.8);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}

.commentary-section {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    height: 400px;
    overflow-y: auto;
    border: 1px solid #e9ecef;
}

body.dark-mode .commentary-section {
    background: #232527;
    border-color: #333;
}

.commentary-item {
    padding: 0.8rem;
    margin-bottom: 0.8rem;
    border-left: 3px solid #dc0000;
    background: white;
    border-radius: 0 8px 8px 0;
}

body.dark-mode .commentary-item {
    background: #2a2d30;
}

.prediction-updates {
    background: #e8f4fd;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    height: 400px;
    overflow-y: auto;
    border: 1px solid #bee5eb;
}

body.dark-mode .prediction-updates {
    background: #1a1d1f;
    border-color: #2c3e50;
}

.prediction-item {
    padding: 0.8rem;
    margin-bottom: 0.8rem;
    background: white;
    border-radius: 8px;
    border-left: 3px solid #17a2b8;
}

body.dark-mode .prediction-item {
    background: #2a2d30;
}

.mock-race-details {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}

body.dark-mode .mock-race-details {
    background: #232527;
}

.grid-position {
    display: inline-block;
    background: #f8f9fa;
    padding: 0.3rem 0.6rem;
    margin: 0.2rem;
    border-radius: 4px;
    font-size: 0.85rem;
    color: #212529;
}

body.dark-mode .grid-position {
    background: #2a2d30;
    color: #e5e7eb;
}

.grid-position.pole {
    background: #ffd700;
    color: #000;
    font-weight: bold;
}

.grid-position.front-row {
    background: #c0c0c0;
    color: #000;
    font-weight: bold;
}

.grid-position.top-10 {
    background: #cd7f32;
    color: #fff;
}

.race-progress-section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}

body.dark-mode .race-progress-section {
    background: #232527;
}

.race-info {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

body.dark-mode .race-info {
    background: rgba(255, 255, 255, 0.05);
}

.race-progress {
    background: rgba(255, 255, 255, 0.2);
    height: 8px;
    border-radius: 4px;
    margin: 1rem 0;
    overflow: hidden;
}

.race-progress-bar {
    background: #fff;
    height: 100%;
    width: 35%;
    border-radius: 4px;
    transition: width 0.3s ease;
}

.pre-race-predictions, .live-predictions {
    background: #fff3cd;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

body.dark-mode .pre-race-predictions,
body.dark-mode .live-predictions {
    background: #332b00;
}

.prediction-comparison {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    margin: 0.2rem 0;
    background: #f8f9fa;
    border-radius: 4px;
}

body.dark-mode .prediction-comparison {
    background: #2a2d30;
}

@media (max-width: 768px) {
    .commentary-section,
    .prediction-updates {
        height: 300px;
    }
    
    .d-flex.gap-2 {
        flex-direction: column;
        gap: 0.5rem !important;
    }
    
    .live-toggle {
        margin-left: 0;
        margin-top: 10px;
        width: 100%;
    }
    
    .live-indicator {
        width: 100%;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Live Header -->
    <div class="live-header">
        <h1><i class="fas fa-broadcast-tower me-2"></i>Live Race Updates</h1>
        {% if current_event %}
            <h3>{{ current_event.name }}</h3>
            <p class="mb-0">
                <i class="fas fa-map-marker-alt me-1"></i>{{ current_event.circuit.name }} |
                <i class="fas fa-calendar me-1"></i>{{ current_event.date|date:"F j, Y" }}
            </p>
            <div class="live-status">
                <i class="fas fa-circle text-warning me-1"></i>Waiting for Race to Start
            </div>
        {% else %}
            <h3>No Upcoming Races</h3>
            <p class="mb-0">Check back later for live updates</p>
        {% endif %}
    </div>

    <!-- Mock Race Simulation Interface -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="content-box">
                <h4 class="mb-3">
                    <i class="fas fa-play-circle me-2"></i>Mock Live Race Simulation
                </h4>
                <p class="text-muted mb-3">
                    Experience how live ML predictions work with our realistic race simulation.
                    Choose from historical races (with known poor performance) or upcoming events.
                </p>

                <!-- Simulation Controls -->
                <div class="row" id="simulationControls">
                    <div class="col-md-3">
                        <label class="form-label">Select Track</label>
                        <select class="form-select" id="trackSelect">
                            {% for track in available_tracks %}
                                <option value="{{ track.name }}" data-type="{{ track.type }}" data-mae="{{ track.mae|default:'' }}">
                                    {{ track.name }}
                                    {% if track.type == 'historical' %} (MAE: {{ track.mae }}){% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Race Speed</label>
                        <select class="form-select" id="speedSelect">
                            <option value="5min">5 minutes</option>
                            <option value="10min" selected>10 minutes</option>
                            <option value="15min">15 minutes</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Actions</label>
                        <div class="d-flex align-items-end">
                            <button class="btn btn-success" id="startRaceBtn">
                                <i class="fas fa-play me-1"></i>Start Mock Race
                            </button>
                            <button class="btn btn-danger d-none" id="stopRaceBtn">
                                <i class="fas fa-stop me-1"></i>Stop Race
                            </button>
                            <div class="live-toggle">
                                <button class="live-indicator inactive" id="liveToggle">
                                    <span class="pulse"></span>
                                    <span id="liveStatus">LIVE</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Race Status</label>
                        <div id="raceStatus" class="alert alert-secondary mb-0">
                            <i class="fas fa-circle text-secondary me-1"></i>No active simulation
                        </div>
                    </div>
                </div>

                <!-- Interactive Events (shown during race) -->
                <div class="row mt-3 d-none" id="interactiveEvents">
                    <div class="col-12">
                        <h6>Interactive Events <span class="badge bg-primary" id="eventsRemaining">2 remaining</span></h6>
                        <div class="btn-group" role="group">
                            <button class="btn btn-warning btn-sm" id="safetyCarBtn">
                                <i class="fas fa-car me-1"></i>Safety Car
                            </button>
                            <button class="btn btn-info btn-sm" id="badPitStopBtn">
                                <i class="fas fa-tools me-1"></i>Bad Pit Stop
                            </button>
                            <button class="btn btn-primary btn-sm" id="weatherChangeBtn">
                                <i class="fas fa-cloud-rain me-1"></i>Weather Change
                            </button>
                        </div>
                        <small class="text-muted d-block mt-1">
                            You can trigger up to 2 events during the race (stops at 10 laps to go)
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mock Race Details -->
    <div class="row mb-4 d-none" id="mockRaceDetails">
        <div class="col-12">
            <div class="mock-race-details">
                <h4 class="mb-3">
                    <i class="fas fa-info-circle me-2"></i>Mock Race Context
                </h4>
                <div class="row">
                    <div class="col-md-6">
                        <h6>Starting Grid (Qualifying Results)</h6>
                        <div id="startingGrid">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>ML Predictions Timeline</h6>
                        <div id="predictionTimeline">
                            <div class="pre-race-predictions" id="preRacePredictions">
                                <strong>Pre-Race ML Prediction:</strong>
                                <div id="preRacePredictionContent">
                                    <em>Available after race starts</em>
                                </div>
                            </div>
                            <div class="live-predictions d-none" id="livePredictions">
                                <strong>Current Live Prediction:</strong>
                                <div id="livePredictionContent">
                                    <em>Updates during race</em>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Live Commentary -->
        <div class="col-lg-8">
            <div class="commentary-section" id="commentarySection">
                <h4 class="mb-3">
                    <i class="fas fa-microphone me-2"></i>Live Commentary
                    <span class="badge bg-secondary ms-2" id="commentaryStatus">Waiting</span>
                </h4>

                <div id="commentaryFeed">
                    {% if current_event %}
                        <div class="commentary-item">
                            <div class="commentary-time">Pre-Race</div>
                            <div class="commentary-text">
                                Welcome to the {{ current_event.name }}! Toggle LIVE mode or start a mock simulation to see live commentary in action.
                            </div>
                        </div>
                    {% else %}
                        <div class="coming-soon">
                            <i class="fas fa-clock"></i>
                            <h5>No Live Race</h5>
                            <p>Toggle LIVE mode for real race data or start a mock race simulation to see live commentary and ML predictions in action.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Prediction Updates -->
        <div class="col-lg-4">
            <div class="prediction-updates" id="predictionUpdates">
                <h4 class="mb-3">
                    <i class="fas fa-chart-line me-2"></i>ML Prediction Updates
                    <span class="badge bg-secondary ms-2" id="mlStatus">Stopped</span>
                </h4>

                <div id="predictionFeed">
                    <div class="coming-soon">
                        <i class="fas fa-robot"></i>
                        <h5>ML Predictions</h5>
                        <p>Toggle LIVE mode for real ML predictions or start a mock race to see live ML prediction updates. Models will update every 30 seconds until 10 laps to go.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Race Progress -->
    <div class="row">
        <div class="col-12">
            {% if current_event %}
                <div class="race-progress-section">
                    <h4 class="mb-3">
                        <i class="fas fa-flag-checkered me-2"></i>Race Progress
                    </h4>

                    <div class="race-info">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Lap:</strong> <span id="currentLap">0/53</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Leader:</strong> <span id="currentLeader">Grid Formation</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Gap:</strong> <span id="leaderGap">----</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Weather:</strong> <span id="currentWeather">Clear</span>
                            </div>
                        </div>
                    </div>

                    <div class="race-progress">
                        <div class="race-progress-bar" id="raceProgressBar"></div>
                    </div>

                    <div class="text-center">
                        <small class="text-muted" id="raceProgressText">
                            Race will begin in approximately 5 minutes
                        </small>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Live mode variables
let isLiveMode = false;
let liveDataInterval = null;

// Page JS extracted to static/js/live_updates.js
// Auto-scroll commentary to bottom
document.addEventListener('DOMContentLoaded', function() {
    const commentarySection = document.querySelector('.commentary-section');
    if (commentarySection) {
        commentarySection.scrollTop = commentarySection.scrollHeight;
    }

    const predictionSection = document.querySelector('.prediction-updates');
    if (predictionSection) {
        predictionSection.scrollTop = predictionSection.scrollHeight;
    }

    // Live toggle functionality
    document.getElementById('liveToggle').addEventListener('click', toggleLiveMode);

    // Mock Race Simulation JavaScript
    let raceInterval = null;
    let isRaceActive = false;
    let preRacePrediction = null;

    // Event listeners
    document.getElementById('startRaceBtn').addEventListener('click', startMockRace);
    document.getElementById('stopRaceBtn').addEventListener('click', stopMockRace);
    document.getElementById('safetyCarBtn').addEventListener('click', () => triggerEvent('safety_car'));
    document.getElementById('badPitStopBtn').addEventListener('click', () => triggerEvent('bad_pit_stop'));
    document.getElementById('weatherChangeBtn').addEventListener('click', () => triggerEvent('weather_change'));

    function toggleLiveMode() {
        isLiveMode = !isLiveMode;
        const toggle = document.getElementById('liveToggle');
        const status = document.getElementById('liveStatus');
        const commentaryStatus = document.getElementById('commentaryStatus');
        const mlStatus = document.getElementById('mlStatus');

        if (isLiveMode) {
            // Enable live mode
            toggle.classList.remove('inactive');
            status.textContent = 'LIVE';
            commentaryStatus.classList.remove('bg-secondary');
            commentaryStatus.classList.add('bg-success');
            commentaryStatus.textContent = 'Live';
            
            mlStatus.classList.remove('bg-secondary', 'd-none');
            mlStatus.classList.add('bg-success');
            mlStatus.textContent = 'Active';

            // Clear existing content and show live waiting message
            document.getElementById('commentaryFeed').innerHTML = `
                <div class="commentary-item">
                    <div class="commentary-time">LIVE</div>
                    <div class="commentary-text">Live mode activated. Waiting for real race data from backend...</div>
                </div>
            `;

            document.getElementById('predictionFeed').innerHTML = `
                <div class="prediction-item">
                    <div class="prediction-driver">LIVE ML PREDICTIONS</div>
                    <div class="prediction-change">Waiting for real-time ML prediction data...</div>
                </div>
            `;

            // Start polling for live data
            startLiveDataPolling();

        } else {
            // Disable live mode
            toggle.classList.add('inactive');
            status.textContent = 'LIVE';
            commentaryStatus.classList.remove('bg-success');
            commentaryStatus.classList.add('bg-secondary');
            commentaryStatus.textContent = 'Waiting';
            
            mlStatus.classList.remove('bg-success');
            mlStatus.classList.add('bg-secondary', 'd-none');
            mlStatus.textContent = 'Stopped';

            // Stop live data polling
            stopLiveDataPolling();

            // Reset to default content
            resetToDefaultContent();
        }
    }

    function startLiveDataPolling() {
        // Poll for live data every 5 seconds
        liveDataInterval = setInterval(fetchLiveData, 5000);
        // Also fetch immediately
        fetchLiveData();
    }

    function stopLiveDataPolling() {
        if (liveDataInterval) {
            clearInterval(liveDataInterval);
            liveDataInterval = null;
        }
    }

    async function fetchLiveData() {
        try {
            const response = await fetch('/api/live-race-data/', {
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();

            if (data.success) {
                // Update commentary
                if (data.commentary && data.commentary.length > 0) {
                    data.commentary.forEach(comment => {
                        addCommentary(comment.time || 'LIVE', comment.message);
                    });
                }

                // Update ML predictions
                if (data.ml_predictions) {
                    updateLiveMLPredictions(data.ml_predictions);
                }

                // Update race progress
                if (data.race_progress) {
                    updateRaceProgress(data.race_progress);
                }
            }
        } catch (error) {
            console.error('Error fetching live data:', error);
            addCommentary('System', 'Connection error - retrying...');
        }
    }

    function updateLiveMLPredictions(predictions) {
        const predictionFeed = document.getElementById('predictionFeed');
        let predictionsHtml = '<div class="live-ml-header"><h6>Live ML Predictions</h6></div>';

        if (predictions.models && Object.keys(predictions.models).length > 0) {
            Object.keys(predictions.models).forEach(modelName => {
                const modelData = predictions.models[modelName];
                
                predictionsHtml += `<div class="model-predictions mb-3">
                    <h6 class="model-name">${modelName.replace('_', ' ').toUpperCase()}</h6>`;

                if (modelData.top_predictions) {
                    modelData.top_predictions.slice(0, 5).forEach(pred => {
                        predictionsHtml += `
                            <div class="prediction-item">
                                <div class="prediction-driver">
                                    P${pred.predicted_position}: ${pred.driver_name}
                                </div>
                                <div class="prediction-change">
                                    Confidence: <strong>${pred.confidence}%</strong>
                                    <span class="text-muted">(Currently P${pred.current_position})</span>
                                </div>
                            </div>
                        `;
                    });
                }

                predictionsHtml += '</div>';
            });
        } else {
            predictionsHtml += '<div class="prediction-item"><div class="prediction-driver">No predictions available</div></div>';
        }

        predictionFeed.innerHTML = predictionsHtml;
    }

    function updateRaceProgress(progress) {
        if (progress.current_lap) {
            document.getElementById('currentLap').textContent = `${progress.current_lap}/${progress.total_laps}`;
        }
        if (progress.leader) {
            document.getElementById('currentLeader').textContent = progress.leader;
        }
        if (progress.gap) {
            document.getElementById('leaderGap').textContent = progress.gap;
        }
        if (progress.weather) {
            document.getElementById('currentWeather').textContent = progress.weather;
        }
        if (progress.progress_percentage) {
            document.getElementById('raceProgressBar').style.width = `${progress.progress_percentage}%`;
        }
        if (progress.status_text) {
            document.getElementById('raceProgressText').textContent = progress.status_text;
        }
    }

    function resetToDefaultContent() {
        // Reset commentary
        document.getElementById('commentaryFeed').innerHTML = `
            <div class="coming-soon">
                <i class="fas fa-clock"></i>
                <h5>No Live Race</h5>
                <p>Toggle LIVE mode for real race data or start a mock race simulation to see live commentary and ML predictions in action.</p>
            </div>
        `;

        // Reset predictions
        document.getElementById('predictionFeed').innerHTML = `
            <div class="coming-soon">
                <i class="fas fa-robot"></i>
                <h5>ML Predictions</h5>
                <p>Toggle LIVE mode for real ML predictions or start a mock race to see live ML prediction updates.</p>
            </div>
        `;
    }

    async function startMockRace() {
        // Disable live mode when starting mock race
        if (isLiveMode) {
            toggleLiveMode();
        }

        const trackName = document.getElementById('trackSelect').value;
        const speed = document.getElementById('speedSelect').value;

        try {
            const response = await fetch('/api/mock-race/start/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    event_name: trackName,
                    simulation_speed: speed
                })
            });

            const data = await response.json();

            if (data.success) {
                isRaceActive = true;
                updateRaceStatus(`Race Started: ${trackName}`, 'success');

                // Show mock race details
                document.getElementById('mockRaceDetails').classList.remove('d-none');

                // Generate and display starting grid and pre-race prediction using same order
                const startingOrder = generateStartingGrid();
                generatePreRacePrediction(startingOrder);

                // Update UI
                document.getElementById('startRaceBtn').classList.add('d-none');
                document.getElementById('stopRaceBtn').classList.remove('d-none');
                document.getElementById('interactiveEvents').classList.remove('d-none');
                document.getElementById('simulationControls').classList.add('mb-3');

                // Clear existing commentary
                document.getElementById('commentaryFeed').innerHTML = '';
                document.getElementById('predictionFeed').innerHTML = '';

                // Start polling for updates (convert seconds to milliseconds)
                const pollInterval = Math.max(1000, data.lap_interval * 1000); // At least 1 second
                raceInterval = setInterval(pollRaceStatus, pollInterval);

                // Also poll immediately to get first update
                setTimeout(pollRaceStatus, 500);

                addCommentary('Race Control', `${trackName} simulation started! ${data.total_laps} laps ahead. Grid positions and pre-race predictions generated.`);
            } else {
                updateRaceStatus('Failed to start race', 'danger');
            }
        } catch (error) {
            console.error('Error starting race:', error);
            updateRaceStatus('Error starting race', 'danger');
        }
    }

    function generateStartingGrid() {
        const startingGrid = document.getElementById('startingGrid');
        const order = [...f1_2025_drivers].slice(0, 20).sort(() => Math.random() - 0.5);

        let gridHtml = '';
        order.forEach((driver, index) => {
            const position = index + 1;
            let positionClass = 'grid-position';

            if (position === 1) {
                positionClass += ' pole';
            } else if (position === 2) {
                positionClass += ' front-row';
            } else if (position <= 10) {
                positionClass += ' top-10';
            }

            gridHtml += `<span class="${positionClass}">P${position}: ${driver}</span>`;
        });

        startingGrid.innerHTML = gridHtml;
        return order;
    }

    function generatePreRacePrediction(order) {
        const drivers = order && order.length ? order : [...f1_2025_drivers].slice(0, 20);
        preRacePrediction = [...drivers];

        const preRaceContent = document.getElementById('preRacePredictionContent');
        let predictionHtml = '';

        preRacePrediction.slice(0, 10).forEach((driver, index) => {
            const position = index + 1;
            predictionHtml += `
                <div class="prediction-comparison">
                    <span>P${position}: ${driver}</span>
                    <small class="text-muted">Pre-race model</small>
                </div>
            `;
        });

        preRaceContent.innerHTML = predictionHtml;
    }

    function addCommentary(time, message) {
        const commentaryFeed = document.getElementById('commentaryFeed');
        const commentaryItem = document.createElement('div');
        commentaryItem.className = 'commentary-item';
        commentaryItem.innerHTML = `
            <div class="commentary-time">${time}</div>
            <div class="commentary-text">${message}</div>
        `;

        commentaryFeed.appendChild(commentaryItem);

        // Auto-scroll to bottom
        const commentarySection = document.getElementById('commentarySection');
        commentarySection.scrollTop = commentarySection.scrollHeight;

        // Keep only last 20 items
        const items = commentaryFeed.children;
        if (items.length > 20) {
            commentaryFeed.removeChild(items[0]);
        }
    }

    function updateRaceStatus(message, type) {
        const statusElement = document.getElementById('raceStatus');
        statusElement.className = `alert alert-${type} mb-0`;

        const iconMap = {
            'success': 'fas fa-circle text-success',
            'warning': 'fas fa-circle text-warning',
            'danger': 'fas fa-circle text-danger',
            'primary': 'fas fa-checkered-flag text-primary'
        };

        statusElement.innerHTML = `<i class="${iconMap[type] || 'fas fa-circle text-secondary'} me-1"></i>${message}`;
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    async function stopMockRace() {
        try {
            await fetch('/api/mock-race/stop/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            resetRaceUI();
        } catch (error) {
            console.error('Error stopping race:', error);
        }
    }

    async function pollRaceStatus() {
        if (!isRaceActive) return;

        try {
            const response = await fetch('/api/mock-race/status/');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const data = await response.json();
            if (data.success && data.race_data) {
                const raceData = data.race_data;
                
                // Update race status and commentary
                if (raceData.status === 'running') {
                    updateRaceStatus(
                        `Lap ${raceData.current_lap}/${raceData.total_laps}`,
                        'success'
                    );
                }

                // Add new commentary
                if (raceData.commentary && raceData.commentary.length > 0) {
                    raceData.commentary.forEach(comment => {
                        addCommentary(`Lap ${comment.lap}`, comment.message);
                    });
                }

                // Update predictions
                if (raceData.ml_predictions) {
                    updateMLPredictions(raceData.ml_predictions);
                }
            }
        } catch (error) {
            console.error('Error polling race:', error);
        }
    }

    async function triggerEvent(eventType) {
        try {
            const response = await fetch('/api/mock-race/event/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ event_type: eventType })
            });

            const data = await response.json();
            if (data.success) {
                addCommentary('Event', data.message);
            }
        } catch (error) {
            console.error('Error triggering event:', error);
        }
    }

    function updateMLPredictions(predictions) {
        const predictionFeed = document.getElementById('predictionFeed');
        let html = '<h6>Mock ML Predictions</h6>';
        
        if (predictions && Object.keys(predictions).length > 0) {
            Object.keys(predictions).slice(0, 5).forEach((driver, index) => {
                html += `
                    <div class="prediction-item">
                        <div class="prediction-driver">P${index + 1}: ${driver}</div>
                        <div class="prediction-change">Predicted position updated</div>
                    </div>
                `;
            });
        }
        
        predictionFeed.innerHTML = html;
    }

    function resetRaceUI() {
        isRaceActive = false;
        if (raceInterval) {
            clearInterval(raceInterval);
            raceInterval = null;
        }
        
        document.getElementById('mockRaceDetails').classList.add('d-none');
        document.getElementById('startRaceBtn').classList.remove('d-none');
        document.getElementById('stopRaceBtn').classList.add('d-none');
        document.getElementById('interactiveEvents').classList.add('d-none');
        
        updateRaceStatus('No active simulation', 'secondary');
    }

    // F1 2025 drivers list for mock functionality
    const f1_2025_drivers = [
        'Max Verstappen', 'Sergio Perez', 'Lewis Hamilton', 'George Russell',
        'Charles Leclerc', 'Carlos Sainz', 'Lando Norris', 'Oscar Piastri',
        'Fernando Alonso', 'Lance Stroll', 'Esteban Ocon', 'Pierre Gasly',
        'Alexander Albon', 'Logan Sargeant', 'Valtteri Bottas', 'Zhou Guanyu',
        'Kevin Magnussen', 'Nico Hulkenberg', 'Yuki Tsunoda', 'Daniel Ricciardo'
    ];
});
</script>
{% endblock %}