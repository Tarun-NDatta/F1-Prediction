{% extends 'base.html' %}

{% block title %}Forgot Password{% endblock %}

{% block extra_css %}
<style>
.forgot-password-container {
    max-width: 380px;
    margin: 2.5rem auto 3rem auto;
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
    border-radius: 18px;
    box-shadow: 0 8px 32px rgba(220,20,60,0.10), 0 1.5px 8px rgba(0,0,0,0.06);
    border: 1.5px solid #e9ecef;
    padding: 2.5rem 2rem 2rem 2rem;
}

body.dark-mode .forgot-password-container {
    background: linear-gradient(135deg, #232527 0%, #181a1a 100%);
    color: #fff;
    border: 1.5px solid #333;
}

.forgot-password-title {
    color: var(--f1-red, #dc143c);
    font-weight: bold;
    text-align: center;
    margin-bottom: 1.5rem;
}

.form-label {
    color: var(--f1-red, #dc143c);
    font-weight: 500;
}

.form-control {
    border-radius: 8px;
    border: 1px solid #e9ecef;
    margin-bottom: 1.2rem;
    padding: 0.7em 1em;
    width: 100%;
    font-size: 1rem;
}

body.dark-mode .form-control {
    background: #232527;
    color: #fff;
    border: 1px solid #444;
}

.btn-forgot {
    background: var(--f1-gradient);
    color: #fff;
    border: none;
    border-radius: 8px;
    width: 100%;
    font-weight: bold;
    padding: 0.7em 0;
    margin-top: 0.5em;
    transition: background 0.2s;
}

.btn-forgot:hover {
    background: var(--f1-red, #dc143c);
}

.btn-secondary {
    background: #6c757d;
    color: #fff;
    border: none;
    border-radius: 8px;
    width: 100%;
    font-weight: bold;
    padding: 0.7em 0;
    margin-top: 0.5em;
    transition: background 0.2s;
}

.btn-secondary:hover {
    background: #5a6268;
}

.step-indicator {
    display: flex;
    justify-content: center;
    margin-bottom: 2rem;
}

.step {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin: 0 0.5rem;
}

.step.active {
    background: var(--f1-red, #dc143c);
    color: white;
}

.step.completed {
    background: #28a745;
    color: white;
}

.step-line {
    width: 40px;
    height: 2px;
    background: #e9ecef;
    margin: auto 0;
}

.step-line.completed {
    background: #28a745;
}

.email-info {
    background: #e3f2fd;
    border: 1px solid #2196f3;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    text-align: center;
}

body.dark-mode .email-info {
    background: #1a237e;
    border-color: #3f51b5;
    color: #fff;
}

.resend-link {
    text-align: center;
    margin-top: 1rem;
}

.resend-link a {
    color: var(--f1-red, #dc143c);
    text-decoration: none;
}

.resend-link a:hover {
    text-decoration: underline;
}

.back-to-login {
    text-align: center;
    margin-top: 1.5rem;
}

.back-to-login a {
    color: var(--f1-red, #dc143c);
    text-decoration: none;
}

.back-to-login a:hover {
    text-decoration: underline;
}
</style>
{% endblock %}

{% block content %}
<div class="forgot-password-container">
    <!-- Step Indicator -->
    <div class="step-indicator">
        <div class="step {% if step >= 1 %}active{% endif %}">1</div>
        <div class="step-line {% if step >= 2 %}completed{% endif %}"></div>
        <div class="step {% if step >= 2 %}active{% endif %}">2</div>
        <div class="step-line {% if step >= 3 %}completed{% endif %}"></div>
        <div class="step {% if step >= 3 %}active{% endif %}">3</div>
    </div>

    {% if step == 1 %}
        <!-- Step 1: Enter Email/Username -->
        <h2 class="forgot-password-title">Forgot Password</h2>
        <p style="text-align: center; margin-bottom: 1.5rem; color: #6c757d;">
            Enter your email or username to receive a temporary password.
        </p>
        
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %}" 
                     style="color: #fff; background: {% if message.tags == 'error' %}var(--f1-red, #dc143c){% else %}#28a745{% endif %}; border-radius: 8px; padding: 0.7em 1em; margin-bottom: 1em;">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
        
        <form method="post" action="{% url 'forgot_password' %}">
            {% csrf_token %}
            <label class="form-label" for="email_or_username">Email or Username</label>
            <input type="text" class="form-control" id="email_or_username" name="email_or_username" 
                   placeholder="Enter your email or username" required>
            <button class="btn btn-forgot" type="submit">Send Temporary Password</button>
        </form>
        
        <div class="back-to-login">
            <a href="{% url 'login' %}">← Back to Login</a>
            <br>
            <small style="color: #6c757d; margin-top: 0.5rem; display: block;">
                Having issues? Try refreshing the page or clearing your browser cache.
                <br>
                <button id="refresh-csrf" style="background: none; border: none; color: var(--f1-red, #dc143c); text-decoration: underline; cursor: pointer; margin-top: 0.25rem;">
                    Click here to refresh page
                </button>
            </small>
        </div>

    {% elif step == 2 %}
        <!-- Step 2: Enter Temporary Password -->
        <h2 class="forgot-password-title">Enter Temporary Password</h2>
        
        <div class="email-info">
            <strong>Password sent to:</strong><br>
            {{ email }}
        </div>
        
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %}" 
                     style="color: #fff; background: {% if message.tags == 'error' %}var(--f1-red, #dc143c){% else %}#28a745{% endif %}; border-radius: 8px; padding: 0.7em 1em; margin-bottom: 1em;">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
        
        <form method="post" action="{% url 'verify_temp_password' %}">
            {% csrf_token %}
            <label class="form-label" for="temp_password">Temporary Password</label>
            <input type="text" class="form-control" id="temp_password" name="temp_password" 
                   placeholder="Enter the password sent to your email" required>
            <button class="btn btn-forgot" type="submit">Verify Password</button>
        </form>
        
        <div class="resend-link">
            <a href="{% url 'resend_temp_password' %}">Didn't receive the email? Click here to resend</a>
        </div>
        
        <div class="back-to-login">
            <a href="{% url 'login' %}">← Back to Login</a>
        </div>

    {% elif step == 3 %}
        <!-- Step 3: Set New Password -->
        <h2 class="forgot-password-title">Set New Password</h2>
        <p style="text-align: center; margin-bottom: 1.5rem; color: #6c757d;">
            Enter your new password below.
        </p>
        
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %}" 
                     style="color: #fff; background: {% if message.tags == 'error' %}var(--f1-red, #dc143c){% else %}#28a745{% endif %}; border-radius: 8px; padding: 0.7em 1em; margin-bottom: 1em;">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
        
        <form method="post" action="{% url 'reset_password' %}">
            {% csrf_token %}
            <label class="form-label" for="new_password">New Password</label>
            <input type="password" class="form-control" id="new_password" name="new_password" 
                   placeholder="Enter new password (min 8 characters)" required>
            
            <label class="form-label" for="confirm_password">Confirm New Password</label>
            <input type="password" class="form-control" id="confirm_password" name="confirm_password" 
                   placeholder="Confirm new password" required>
            
            <button class="btn btn-forgot" type="submit">Reset Password</button>
        </form>
        
        <div class="back-to-login">
            <a href="{% url 'login' %}">← Back to Login</a>
        </div>
    {% endif %}
</div>

<script>
// Password confirmation validation
document.addEventListener('DOMContentLoaded', function() {
    const newPassword = document.getElementById('new_password');
    const confirmPassword = document.getElementById('confirm_password');
    
    if (newPassword && confirmPassword) {
        function validatePasswords() {
            if (newPassword.value !== confirmPassword.value) {
                confirmPassword.setCustomValidity('Passwords do not match');
            } else {
                confirmPassword.setCustomValidity('');
            }
        }
        
        newPassword.addEventListener('change', validatePasswords);
        confirmPassword.addEventListener('keyup', validatePasswords);
    }
    
    // Add refresh functionality for CSRF issues
    const refreshBtn = document.getElementById('refresh-csrf');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function(e) {
            e.preventDefault();
            window.location.reload();
        });
    }
});
</script>
{% endblock %} 