{% extends 'base.html' %}
{% load dashboard_extras %}
{% block title %}F1 Predictions{% endblock %}

{% block extra_css %}
<style>
.prediction-header {
    background: var(--f1-gradient);
    color: white;
    padding: 2rem;
    margin-bottom: 2rem;
    border-radius: 12px;
    text-align: center;
}
.content-box {
    border-radius: 20px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    margin-bottom: 2rem;
    padding: 2rem 1.5rem;
}
.model-selector .form-select {
    border-radius: 8px;
    min-height: 44px;
    font-size: 1.1rem;
    background: #fff;
    color: #232527;
    border: 1.5px solid #e9ecef;
}
body.dark-mode .model-selector .form-select {
    background: #232527;
    color: #fff;
    border: 1.5px solid #444;
}
.model-selector .form-select option:disabled {
    color: #999;
    font-style: italic;
}
.overview-stats {
    display: flex;
    justify-content: center;
    gap: 2.5rem;
    margin-top: 1.5rem;
}
.overview-stat {
    text-align: center;
    flex: 1;
}
.overview-stat-value {
    font-size: 2.2rem;
    font-weight: bold;
    margin-bottom: 0.2rem;
}
body.light-mode .overview-stat-value { color: var(--f1-red); }
body.dark-mode .overview-stat-value { color: var(--f1-gold); }
.overview-stat-label {
    font-size: 1rem;
    color: #6b7280;
}
body.dark-mode .overview-stat-label { color: #ccc; }
.table th, .table td {
    vertical-align: middle;
    font-size: 1rem;
    padding: 0.9rem 1.2rem;
}
.table th {
    background: #f8f9fa;
    color: var(--f1-red);
    font-weight: 700;
    border-bottom: 2px solid #e9ecef;
}
body.dark-mode .table th {
    background: #232527 !important;
    color: #fff !important;
    border-color: #333 !important;
}
body.dark-mode .table td {
    background: #232527 !important;
    color: #fff !important;
    border-color: #333 !important;
}
.table tbody tr:hover {
    background: rgba(220, 20, 60, 0.06);
}
body.dark-mode .table tbody tr:hover {
    background: rgba(255,255,255,0.04) !important;
}

/* Model Stats Styling */
.model-stats {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 1rem;
    border-left: 4px solid var(--f1-red);
}
body.dark-mode .model-stats {
    background: linear-gradient(135deg, #2a2d30 0%, #232527 100%);
    border-left-color: var(--f1-gold);
}
.model-stats h5 {
    color: var(--f1-red);
    margin-bottom: 1rem;
    font-weight: 600;
}
body.dark-mode .model-stats h5 {
    color: var(--f1-gold);
}
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
}
.stat-item {
    text-align: center;
    padding: 0.8rem;
    background: rgba(255,255,255,0.7);
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,0.1);
}
body.dark-mode .stat-item {
    background: rgba(255,255,255,0.05);
    border-color: rgba(255,255,255,0.1);
}
.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--f1-red);
    margin-bottom: 0.2rem;
}
body.dark-mode .stat-value {
    color: var(--f1-gold);
}
.stat-label {
    font-size: 0.8rem;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
body.dark-mode .stat-label {
    color: #ccc;
}

/* Subscription Alert Styling */
.subscription-alert {
    background: rgba(220, 53, 69, 0.1);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
    border-left: 4px solid #dc3545;
}
body.dark-mode .subscription-alert {
    background: rgba(220, 53, 69, 0.2);
}
.subscription-alert h6 {
    color: #dc3545;
    margin-bottom: 0.5rem;
}
.subscription-alert p {
    margin: 0;
    color: #6b7280;
}
body.dark-mode .subscription-alert p {
    color: #ccc;
}
.subscription-alert a {
    color: var(--f1-red);
    text-decoration: none;
    font-weight: 500;
}
.subscription-alert a:hover {
    text-decoration: underline;
}

/* Prediction vs Actual Visualization */
.prediction-vs-actual {
    margin-top: 3rem;
    padding: 2rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 16px;
    border: 1px solid rgba(0,0,0,0.1);
}
body.dark-mode .prediction-vs-actual {
    background: linear-gradient(135deg, #2a2d30 0%, #232527 100%);
    border-color: rgba(255,255,255,0.1);
}
.prediction-vs-actual h3 {
    color: var(--f1-red);
    margin-bottom: 1.5rem;
    text-align: center;
    font-weight: 600;
}
body.dark-mode .prediction-vs-actual h3 {
    color: var(--f1-gold);
}
.chart-container {
    position: relative;
    height: 400px;
    margin: 2rem 0;
}
.scatter-plot {
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.9);
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,0.1);
}
body.dark-mode .scatter-plot {
    background: rgba(255,255,255,0.05);
    border-color: rgba(255,255,255,0.1);
}
.chart-legend {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin-top: 1rem;
    flex-wrap: wrap;
}
.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}
.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}
.legend-color.correct { background-color: #28a745; }
.legend-color.incorrect { background-color: #dc3545; }
.legend-color.future { background-color: #6c757d; }

/* Race Details Styling */
.race-details {
    background: #fff;
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    overflow: hidden;
}
body.dark-mode .race-details {
    background: #232527;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.race-header {
    background: linear-gradient(135deg, var(--f1-red) 0%, #b91c1c 100%);
    color: white;
    padding: 1rem 1.5rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background 0.3s ease;
}
body.dark-mode .race-header {
    background: linear-gradient(135deg, var(--f1-red) 0%, #b91c1c 100%);
    color: white;
}
.race-header:hover {
    background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
}
body.dark-mode .race-header:hover {
    background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
}
.race-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin: 0;
}
.race-subtitle {
    font-size: 0.9rem;
    opacity: 0.9;
    margin: 0.2rem 0 0 0;
}
.race-arrow {
    font-size: 1.2rem;
    transition: transform 0.3s ease;
}
.race-arrow.rotated {
    transform: rotate(180deg);
}
.race-details-content {
    display: none;
    padding: 1.5rem;
}
.correct-prediction {
    background-color: rgba(40, 167, 69, 0.1);
}
body.dark-mode .correct-prediction {
    background-color: rgba(40, 167, 69, 0.2);
}
.incorrect-prediction {
    background-color: rgba(220, 53, 69, 0.1);
}
body.dark-mode .incorrect-prediction {
    background-color: rgba(220, 53, 69, 0.2);
}
.team-badge {
    padding: 0.3rem 0.6rem;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}
.coming-soon-table-message {
    text-align: center;
    padding: 3rem 2rem;
    color: #6b7280;
}
body.dark-mode .coming-soon-table-message {
    color: #ccc;
}
.model-badge {
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    margin-left: 1rem;
}
.model-badge-active {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
    border: 1px solid rgba(40, 167, 69, 0.3);
}
.model-badge-coming-soon {
    background: rgba(108, 117, 125, 0.2);
    color: #6c757d;
    border: 1px solid rgba(108, 117, 125, 0.3);
}
.predictions-content-blur {
    filter: blur(4px);
    pointer-events: none;
    user-select: none;
}
.predictions-locked-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(20, 20, 30, 0.55);
    z-index: 2000;
}
.locked-prompt {
    background: white;
    padding: 2.5rem;
    border-radius: 16px;
    text-align: center;
    max-width: 400px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
body.dark-mode .locked-prompt {
    background: #232527;
    color: #fff;
}
.locked-prompt h4 {
    color: var(--f1-red);
    margin-bottom: 1rem;
    font-weight: 600;
}
body.dark-mode .locked-prompt h4 {
    color: var(--f1-gold);
}
.locked-prompt p {
    color: #6b7280;
    margin-bottom: 1.5rem;
    line-height: 1.5;
}
body.dark-mode .locked-prompt p {
    color: #ccc;
}
.btn-group {
    display: flex;
    gap: 1rem;
    justify-content: center;
}
.btn-primary {
    background: var(--f1-red);
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 8px;
    color: white;
    text-decoration: none;
    font-weight: 500;
    transition: background 0.3s ease;
}
.btn-primary:hover {
    background: #b91c1c;
    color: white;
    text-decoration: none;
}
.btn-secondary {
    background: #6c757d;
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 8px;
    color: white;
    text-decoration: none;
    font-weight: 500;
    transition: background 0.3s ease;
}
.btn-secondary:hover {
    background: #5a6268;
    color: white;
    text-decoration: none;
}

.model-performance-metrics {
    margin-top: 3rem;
    padding: 2rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 16px;
    border: 1px solid rgba(0,0,0,0.1);
}
body.dark-mode .model-performance-metrics {
    background: linear-gradient(135deg, #2a2d30 0%, #232527 100%);
    border-color: rgba(255,255,255,0.1);
}
.model-performance-metrics h3 {
    color: var(--f1-red);
    margin-bottom: 1.5rem;
    text-align: center;
    font-weight: 600;
}
body.dark-mode .model-performance-metrics h3 {
    color: var(--f1-gold);
}

@media (max-width: 768px) {
    .overview-stats {
        flex-direction: column;
        gap: 1.5rem;
    }
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    .chart-container {
        height: 300px;
    }
    .chart-legend {
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }
}

@media (max-width: 600px) {
    .locked-prompt { padding: 1.2rem 0.5rem; min-width: 0; }
    .locked-prompt h4 { font-size: 1.3rem; }
    .locked-prompt p { font-size: 1rem; }
    .locked-prompt .btn-primary, .locked-prompt .btn-secondary { font-size: 1rem; padding: 0.6rem 1.2rem; }
}
</style>
{% endblock %}

{% block content %}
<div class="prediction-header">
    <h1><i class="fas fa-chart-line me-2"></i>F1 Predictions</h1>
    <p class="lead">Season Overview & Race Predictions</p>
</div>

<div class="prediction-content-wrapper" style="position: relative;">
    <div class="{% if not is_authenticated %}predictions-content-blur{% endif %}">
        <!-- Model Selector (no subscription gating) -->
        <div class="content-box model-selector mb-4">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                <span style="font-size: 1.5rem; color: var(--f1-red);"><i class="fas fa-brain"></i></span>
                <span style="font-size: 1.2rem; font-weight: bold; color: var(--f1-red);">Select Prediction Model</span>
            </div>
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                <span style="color: #6b7280; font-size: 1rem;">Choose which machine learning model to view predictions from</span>
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <select class="form-select" style="max-width: 320px; min-width: 180px;" id="modelSelect">
                        {% for key, model in visible_models_map.items %}
                        <option value="{{ key }}" {% if key == selected_model_key %}selected{% endif %}>{{ model.name }}</option>
                        {% endfor %}
                    </select>
                    {% if subscription_tier == 'PRO' %}
                        <span title="Unlocked" style="display: inline-flex; align-items: center; gap: 0.4rem;">
                            <i class="fas fa-lock-open" style="color: #28a745;"></i>
                            <span style="font-size: 0.95rem; color: #28a745;">All models unlocked</span>
                        </span>
                    {% elif subscription_tier == 'PREMIUM' %}
                        <span title="Unlocked" style="display: inline-flex; align-items: center; gap: 0.4rem;">
                            <i class="fas fa-lock-open" style="color: #28a745;"></i>
                            <span style="font-size: 0.95rem; color: #28a745;">Ridge & XGBoost unlocked</span>
                        </span>
                        <span style="font-size: 0.9rem; color: #6b7280; margin-left: 0.25rem;">Upgrade to Pro to see CatBoost</span>
                    {% else %}
                        <span title="Locked" style="display: inline-flex; align-items: center; gap: 0.4rem;">
                            <i class="fas fa-lock" style="color: #6c757d;"></i>
                            <span style="font-size: 0.95rem; color: #6c757d;">Ridge only</span>
                        </span>
                        <span style="font-size: 0.9rem; color: #6b7280; margin-left: 0.25rem;">Upgrade to see other models</span>
                    {% endif %}
                </div>
            </div>
            
        </div>

        <div class="content-box mb-4">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.2rem;">
                <span style="font-size: 2rem; color: var(--f1-red);"><i class="fas fa-trophy"></i></span>
                <span style="font-size: 1.4rem; font-weight: bold; color: var(--f1-red);">2025 Season Overview</span>
                <span class="model-badge model-badge-active">{{ model_name }}</span>
            </div>
            
            
            <div style="display: flex; gap: 1.5rem; justify-content: center; flex-wrap: wrap;">
                {% if selected_model_key == 'catboost' and race_data.track_info %}
                <div class="season-stat-card" style="background: #f8f9fa; border-radius: 20px; padding: 1.2rem 2.2rem; min-width: 260px; text-align: left;">
                    <div style="font-weight: 700; color: var(--f1-red); margin-bottom: 0.6rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-road"></i> Track Specialization
                    </div>
                    <div style="color: #6b7280; font-size: 0.98rem;">
                        <div><strong>Category:</strong> {{ race_data.track_info.track_category|default:'N/A' }}</div>
                        <div><strong>Power Sensitivity:</strong> {{ race_data.track_info.track_power_sensitivity|default:'N/A' }}</div>
                        <div><strong>Overtaking Difficulty:</strong> {{ race_data.track_info.track_overtaking_difficulty|default:'N/A' }}</div>
                    </div>
                </div>
                {% endif %}
                <div class="season-stat-card" style="background: #f8f9fa; border-radius: 20px; padding: 1.2rem 2.2rem; min-width: 120px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: var(--f1-red);">{{ total_races }}</div>
                    <div style="color: #6b7280; font-size: 1rem;">Total Races</div>
                </div>
                <div class="season-stat-card" style="background: #f8f9fa; border-radius: 20px; padding: 1.2rem 2.2rem; min-width: 120px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: var(--f1-red);">{{ races_with_predictions }}</div>
                    <div style="color: #6b7280; font-size: 1rem;">Races with Predictions</div>
                </div>
                <div class="season-stat-card" style="background: #f8f9fa; border-radius: 20px; padding: 1.2rem 2.2rem; min-width: 120px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: var(--f1-red);">{{ available_rounds_display }}</div>
                    <div style="color: #6b7280; font-size: 1rem;">Available Rounds</div>
                </div>
                <div class="season-stat-card" style="background: #f8f9fa; border-radius: 20px; padding: 1.2rem 2.2rem; min-width: 120px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: var(--f1-red);">{{ model_name }}</div>
                    <div style="color: #6b7280; font-size: 1rem;">Model Used</div>
                </div>
            </div>
        </div>

        <!-- Model Performance Statistics (MAE and Top 3 only) -->
        {% if model_stats %}
        <div class="content-box mb-4">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.2rem;">
                <span style="font-size: 1.8rem; color: var(--f1-red);"><i class="fas fa-chart-bar"></i></span>
                <span style="font-size: 1.3rem; font-weight: bold; color: var(--f1-red);">{{ model_name }} Performance</span>
            </div>
            <div class="model-stats">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">{{ model_stats.mae|floatformat:2 }}</div>
                        <div class="stat-label">MAE</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ model_stats.top_3_accuracy|floatformat:1 }}%</div>
                        <div class="stat-label">Top 3 Accuracy</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ model_stats.top_10_accuracy|floatformat:1 }}%</div>
                        <div class="stat-label">Top 10 Accuracy</div>
                    </div>
                </div>
                <div style="margin-top: 0.75rem; font-size: 0.95rem; color: #6b7280;">
                    <strong>What is MAE?</strong> Mean Absolute Error (MAE) is the average absolute difference between predicted and actual finishing positions. Lower MAE means more accurate predictions because, on average, predictions are closer to the real results.
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Model Comparison Charts (always visible) -->
        <div class="content-box mb-4">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.2rem;">
                <span style="font-size: 1.8rem; color: var(--f1-red);"><i class="fas fa-chart-line"></i></span>
                <span style="font-size: 1.3rem; font-weight: bold; color: var(--f1-red);">Model Comparison</span>
            </div>
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="chart-container" style="height: 260px;">
                        <canvas id="maeCompare"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="chart-container" style="height: 260px;">
                        <canvas id="top3Compare"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="chart-container" style="height: 260px;">
                        <canvas id="top10Compare"></canvas>
                    </div>
                </div>
            </div>
        </div>

        {% if is_authenticated %}
            {% if True %}
                {% for race_data in results %}
                    <div class="race-details">
                        <div class="race-header" onclick="toggleRaceDetails({{ forloop.counter }})">
                            <div>
                                <div class="race-title">Round {{ race_data.event.round }}: {{ race_data.event.name }}</div>
                                <div class="race-subtitle">{{ race_data.event.circuit.name }} • {{ race_data.event.date|date:"F j, Y" }}</div>
                            </div>
                            <span class="race-arrow" id="arrow-{{ forloop.counter }}">▼</span>
                        </div>
                        <div class="race-details-content" id="details-{{ forloop.counter }}">
                            {% if not race_data.show_coming_soon %}
                                <div class="table-responsive" style="max-height: 480px; overflow-y: auto;">
                                    <table class="table" style="border-radius: 12px; overflow: hidden;">
                                        <thead>
                                            <tr>
                                                <th>Pos</th>
                                                <th>Driver</th>
                                                <th>Team</th>
                                                <th>Predicted</th>
                                                <th>Actual</th>
                                                <th>Difference</th>
                                                {% if selected_model_key == 'catboost' %}
                                                {% endif %}
                                                <th>Points</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in race_data.comparison %}
                                            <tr class="{% if item.is_correct %}correct-prediction{% elif item.actual != 'N/A' and not item.is_correct %}incorrect-prediction{% endif %}">
                                                <td class="text-center">{{ forloop.counter }}</td>
                                                <td>{{ item.driver }}</td>
                                                <td><span class="team-badge" style="background-color:{{ item.team_color }};">{{ item.team }}</span></td>
                                                <td class="text-center">{{ item.predicted }}</td>
                                                <td class="text-center">{{ item.actual }}</td>
                                                <td class="text-center">{{ item.difference }}</td>
                                                {% if selected_model_key == 'catboost' %}
                                                {% endif %}
                                                <td class="text-center">{{ item.points }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="coming-soon-table-message">
                                    <span class="model-badge model-badge-coming-soon"><i class="fas fa-tools"></i> Predictions Coming Soon!</span>
                                    <div style="margin-top: 0.5em; color: var(--f1-red); font-weight: 500;">This race's predictions are not yet available.</div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        {% endif %}
    </div>
    
    {% if not is_authenticated %}
    <div class="predictions-locked-overlay">
        <div class="locked-prompt">
            <h4>View Full Predictions</h4>
            <p>Create an account or log in to see detailed race predictions.</p>
            <div class="btn-group">
                <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-primary">Login</a>
                <a href="{% url 'register' %}?next={{ request.path }}" class="btn btn-secondary">Register</a>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// === RACE DETAILS TOGGLE FUNCTIONALITY ===
function toggleRaceDetails(idx) {
    var details = document.getElementById('details-' + idx);
    var arrow = document.getElementById('arrow-' + idx);
    if (details.style.display === 'block') {
        details.style.display = 'none';
        arrow.classList.remove('rotated');
    } else {
        details.style.display = 'block';
        arrow.classList.add('rotated');
    }
}

// === MODEL SELECTION FUNCTIONALITY ===
function changeModel(modelKey) {
    window.location.href = '?model=' + modelKey;
}

// Add event listener for model selection
document.addEventListener('DOMContentLoaded', function() {
    const selectElement = document.querySelector('#modelSelect');
    if (selectElement) {
        selectElement.addEventListener('change', function(e) {
            changeModel(this.value);
        });
    }
});
</script>
<script>
// Model comparison charts (always render)
document.addEventListener('DOMContentLoaded', function() {
    const labels = {{ comparison_labels|safe }};
    const maeData = {{ comparison_mae|safe }};
    const top3Data = {{ comparison_top3|safe }};
    const top10Data = {{ comparison_top10|safe }};

    const palette = ['#e10600', '#0d6efd', '#198754'];

    const maeCtx = document.getElementById('maeCompare');
    if (maeCtx) {
        new Chart(maeCtx.getContext('2d'), {
            type: 'bar',
            data: { labels, datasets: [{ label: 'MAE (lower is better)', data: maeData, backgroundColor: palette }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }}, scales: { y: { beginAtZero: true } } }
        });
    }

    const top3Ctx = document.getElementById('top3Compare');
    if (top3Ctx) {
        new Chart(top3Ctx.getContext('2d'), {
            type: 'bar',
            data: { labels, datasets: [{ label: 'Top 3 Accuracy (%)', data: top3Data, backgroundColor: palette }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }}, scales: { y: { beginAtZero: true, max: 100 } } }
        });
    }

    const top10Ctx = document.getElementById('top10Compare');
    if (top10Ctx) {
        new Chart(top10Ctx.getContext('2d'), {
            type: 'bar',
            data: { labels, datasets: [{ label: 'Top 10 Accuracy (%)', data: top10Data, backgroundColor: palette }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }}, scales: { y: { beginAtZero: true, max: 100 } } }
        });
    }
});
</script>
{% endblock %}