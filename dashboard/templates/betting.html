{% extends 'base.html' %}

{% block title %}Prediction Market - F1 Betting{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="content-box">
                <h1 class="text-center mb-3">
                    <i class="fas fa-coins me-2"></i>Prediction Market
                </h1>
                <p class="text-center mb-0">
                    Place bets on race outcomes using your virtual credits. 
                    <span class="text-warning fw-bold">Current Balance: {{ user_credits }} credits</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Betting Interface -->
    <div class="row">
        <!-- Upcoming Events -->
        <div class="col-lg-8">
            <div class="content-box">
                <h3 class="mb-4">
                    <i class="fas fa-calendar-alt me-2"></i>Upcoming Events
                </h3>
                
                {% for event in upcoming_events %}
                <div class="event-card mb-3" data-event-id="{{ event.id }}">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <h5 class="mb-1">{{ event.name }}</h5>
                            <p class="text-muted mb-0">
                                <i class="fas fa-map-marker-alt me-1"></i>{{ event.circuit.name }}
                            </p>
                        </div>
                        <div class="col-md-3">
                            <p class="mb-0">
                                <i class="fas fa-calendar me-1"></i>{{ event.date|date:"M d, Y" }}
                            </p>
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-primary">Round {{ event.round }}</span>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-primary btn-sm" 
                                    onclick="openBettingModal({{ event.id }}, '{{ event.name }}')">
                                <i class="fas fa-bet me-1"></i>Bet Now
                            </button>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-4">
                    <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No upcoming events available for betting.</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Recent Bets & Quick Stats -->
        <div class="col-lg-4">
            <div class="content-box mb-4">
                <h4 class="mb-3">
                    <i class="fas fa-history me-2"></i>Recent Bets
                </h4>
                {% for bet in recent_bets %}
                <div class="bet-item mb-2 p-2 border-start border-3 border-primary">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <small class="text-muted">{{ bet.event.name }}</small>
                            <p class="mb-1 fw-bold">{{ bet.get_bet_type_display }}</p>
                            {% if bet.driver %}
                            <small>{{ bet.driver.name }}</small>
                            {% endif %}
                        </div>
                        <div class="text-end">
                            <span class="badge bg-{% if bet.status == 'won' %}success{% elif bet.status == 'lost' %}danger{% else %}warning{% endif %}">
                                {{ bet.status|title }}
                            </span>
                            <p class="mb-0 small">{{ bet.credits_staked }} credits</p>
                        </div>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted text-center">No recent bets.</p>
                {% endfor %}
            </div>

            <div class="content-box">
                <h4 class="mb-3">
                    <i class="fas fa-chart-line me-2"></i>Betting Guide
                </h4>
                <div class="betting-guide">
                    <div class="guide-item mb-2">
                        <strong>Podium Finish:</strong> Bet on driver to finish in top 3
                    </div>
                    <div class="guide-item mb-2">
                        <strong>Exact Position:</strong> Predict specific finishing position
                    </div>
                    <div class="guide-item mb-2">
                        <strong>DNF Prediction:</strong> Bet on driver not finishing
                    </div>
                    <div class="guide-item mb-2">
                        <strong>Qualifying Position:</strong> Predict qualifying result
                    </div>
                    <div class="guide-item mb-2">
                        <strong>Fastest Lap:</strong> Bet on fastest lap achievement
                    </div>
                    <div class="guide-item">
                        <strong>Weather Impact:</strong> Bet on weather-related outcomes
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Betting Modal -->
<div class="modal fade" id="bettingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-coins me-2"></i>Place Bet
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bettingForm">
                    <input type="hidden" id="eventId" name="event_id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Event</label>
                                <input type="text" id="eventName" class="form-control" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Bet Type</label>
                                <select class="form-select" id="betType" name="bet_type" required>
                                    <option value="">Select bet type...</option>
                                    {% for bet_type, bet_name in bet_types %}
                                    <option value="{{ bet_type }}">{{ bet_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Driver</label>
                                <select class="form-select" id="driverSelect" name="driver_id">
                                    <option value="">Select driver...</option>
                                    {% for driver in drivers %}
                                    <option value="{{ driver.id }}">{{ driver }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Team</label>
                                <select class="form-select" id="teamSelect" name="team_id">
                                    <option value="">Select team...</option>
                                    {% for team in teams %}
                                    <option value="{{ team.id }}">{{ team.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Position (for position bets)</label>
                                <input type="number" class="form-control" id="positionInput" name="position" min="1" max="20">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Credits to Stake</label>
                                <input type="number" class="form-control" id="creditsStaked" name="credits_staked" min="10" max="{{ user_credits }}" required>
                                <small class="text-muted">Available: {{ user_credits }} credits</small>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <strong>Calculated Odds:</strong> <span id="calculatedOdds">-</span>
                        <br>
                        <strong>Potential Win:</strong> <span id="potentialWin">-</span> credits
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="placeBet()">
                    <i class="fas fa-check me-1"></i>Place Bet
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentEventId = null;

function openBettingModal(eventId, eventName) {
    currentEventId = eventId;
    document.getElementById('eventId').value = eventId;
    document.getElementById('eventName').value = eventName;
    
    // Reset form
    document.getElementById('bettingForm').reset();
    document.getElementById('calculatedOdds').textContent = '-';
    document.getElementById('potentialWin').textContent = '-';
    
    // Show modal
    new bootstrap.Modal(document.getElementById('bettingModal')).show();
}

function calculateOdds() {
    const betType = document.getElementById('betType').value;
    const driverId = document.getElementById('driverSelect').value;
    const teamId = document.getElementById('teamSelect').value;
    const position = document.getElementById('positionInput').value;
    const creditsStaked = document.getElementById('creditsStaked').value;
    
    // Simple odds calculation (in real app, this would be more sophisticated)
    let odds = 2.0;
    
    if (betType === 'podium') {
        odds = 3.0;
    } else if (betType === 'position') {
        if (position <= 3) odds = 4.0;
        else if (position <= 10) odds = 2.5;
        else odds = 1.8;
    } else if (betType === 'dnf') {
        odds = 2.5;
    } else if (betType === 'qualifying') {
        odds = 2.2;
    } else if (betType === 'fastest_lap') {
        odds = 5.0;
    } else if (betType === 'weather') {
        odds = 3.5;
    }
    
    document.getElementById('calculatedOdds').textContent = odds.toFixed(2);
    
    if (creditsStaked) {
        const potentialWin = Math.round(creditsStaked * odds);
        document.getElementById('potentialWin').textContent = potentialWin;
    }
}

function placeBet() {
    const form = document.getElementById('bettingForm');
    const formData = new FormData(form);
    
    fetch('{% url "place_bet" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update credits display
            document.querySelector('.text-warning.fw-bold').textContent = 
                `Current Balance: ${data.new_credits} credits`;
            
            // Show success message
            alert(data.message);
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('bettingModal')).hide();
            
            // Reload page to show updated data
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while placing the bet.');
    });
}

// Add event listeners for odds calculation
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('betType').addEventListener('change', calculateOdds);
    document.getElementById('driverSelect').addEventListener('change', calculateOdds);
    document.getElementById('teamSelect').addEventListener('change', calculateOdds);
    document.getElementById('positionInput').addEventListener('input', calculateOdds);
    document.getElementById('creditsStaked').addEventListener('input', calculateOdds);
});
</script>
{% endblock %} 